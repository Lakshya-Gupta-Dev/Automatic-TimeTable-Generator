<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Slots Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        display: flex;
        height: 100vh;
        background: #f0f4f8;
        margin: 0;
      }
      h4 {
        margin-top: 10px;
        margin-left: 50px;
        font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
      }
      .sidebar {
        width: 260px;
        background: #1f2937;
        color: #fff;
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }

      .sidebar h3 {
        padding: 0 20px;
        margin-bottom: 25px;
        font-size: 16px;
        text-transform: uppercase;
        color: #9ca3af;
        letter-spacing: 1px;
      }

      .sidebar a {
        text-decoration: none;
        color: #d1d5db;
        padding: 12px 25px;
        display: flex;
        align-items: center;
        border-radius: 8px;
        margin: 2px 10px;
      }

      .sidebar a:hover {
        background: #3b82f6;
        color: #fff;
        font-weight: bold;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f9fafb;
        min-height: 100vh;
        transition: margin-left 0.3s;
      }

      .navbar {
        height: 65px;
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        border-radius: 0 0 15px 15px;
      }

      .navbar .search-box input {
        width: 300px;
        padding: 8px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
      }

      .navbar .profile {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        color: #374151;
      }

      .navbar .profile img {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: 2px solid #3b82f6;
      }

      .navbar .profile button {
        background: #ef4444;
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .content {
        height: 490px;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        margin: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
      }

      .table-container {
        flex: 1;
        overflow: auto;
        max-height: 220px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .btn-custom {
        background-color: #3b82f6;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
      }
      .btn-custom:hover {
        background-color: #2563eb;
      }
      .btn-warning {
        background-color: #f59e0b;
      }
      .btn-danger {
        background-color: #ef4444;
      }
      .footer {
        height: 55px;
        background: #1f2937;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
        transition: left 0.3s;
        overflow: hidden;
      }

      .error {
        color: #ef4444;
        font-size: 13px;
        margin-top: 6px;
      }

      @media (max-width: 900px) {
        .navbar .search-box input {
          width: 160px;
        }
        .sidebar {
          display: none;
        }
        body {
          height: auto;
        }
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <h3>Menu</h3>
      <a href="home.html">üè† Home</a>
      <a href="schedules.html">üìÖ Schedules</a>
      <a href="departments.html">üè¢ Departments</a>
      <a href="classes.html">üéì Classes</a>
      <a href="subject.html">üìò Subject</a>
      <a href="section.html">üîñ section</a>
      <a href="teachers.html">üë®‚Äçüè´ Teachers</a>
      <a href="tsmapping.html">üîó Teacher Subject Mapping</a>
      <a href="Room.html">üè´ Rooms</a>
      <a href="timeslot.html">‚è± Time Slot</a>
    </div>

    <div class="main-content">
      <div class="navbar">
        <div class="search-box">
          <input
            type="text"
            id="search-box"
            placeholder="Search time slots..."
          />
        </div>
        <div class="profile">
          <img src="sc1.png" alt="User" />
          <span class="auth-username">Loading...</span>
          <button id="logoutBtn">Logout</button>
        </div>
      </div>

      <h4>Time Slots</h4>

      <div class="content">
        <h5 class="mb-4">Create or Manage Time Slots</h5>

        <form id="timeslot-form" autocomplete="off">
          <div class="row mb-3 gx-3">
            <div class="col-md-3">
              <label class="form-label">Day *</label>
              <select class="form-control" id="day" required>
                <option value="">Select Day</option>
                <option>Monday</option>
                <option>Tuesday</option>
                <option>Wednesday</option>
                <option>Thursday</option>
                <option>Friday</option>
                <option>Saturday</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Start Time (HH:MM) *</label>
              <input
                type="text"
                class="form-control"
                id="startTime"
                placeholder="e.g. 10:00"
                required
              />
              <div id="startError" class="error" style="display: none">
                Invalid time (use HH:MM)
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label">End Time (HH:MM) *</label>
              <input
                type="text"
                class="form-control"
                id="endTime"
                placeholder="e.g. 11:00"
                required
              />
              <div id="endError" class="error" style="display: none">
                Invalid time (use HH:MM)
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Slot Number *</label>
              <input
                type="number"
                class="form-control"
                id="slotNumber"
                min="1"
                required
              />
              <div id="slotError" class="error" style="display: none">
                Slot must be ‚â• 1
              </div>
            </div>
          </div>

          <div class="text-center mb-4">
            <button type="submit" class="btn btn-custom">Confirm</button>
          </div>
        </form>

        <div id="data-section" style="display: none">
          <h6>Time Slots List:</h6>
          <div class="table-container mt-2">
            <table class="table table-bordered table-striped mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Day</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Slot No</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="data-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="footer">Time Table Generator || By SVVV Students 2025</div>
    </div>

    <script>
      // --- config & DOM ---
      const token = localStorage.getItem("token");
      if (!token) location.href = "login1.html";

      const apiUrl = "http://localhost:8080/api/timeslot";
      const profileUrl = "http://localhost:8080/api/user/profile";
      const usernameEl = document.querySelector(".auth-username");
      const logoutBtn = document.getElementById("logoutBtn");
      const form = document.getElementById("timeslot-form");
      const dataBody = document.getElementById("data-body");
      const searchBox = document.getElementById("search-box");
      const startError = document.getElementById("startError");
      const endError = document.getElementById("endError");
      const slotError = document.getElementById("slotError");
      let editId = null;

      // Time regex (24-hour HH:MM)
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

      // Logout
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        location.href = "login1.html";
      });

      // Load user profile (display username)
      async function loadProfile() {
        try {
          const res = await fetch(profileUrl, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) throw new Error("Unauthorized");
          const user = await res.json();
          usernameEl.textContent = user.username || "User";
        } catch (err) {
          console.error(err);
          location.href = "login1.html";
        }
      }

      // Load all slots
      async function loadTimeSlots() {
        try {
          const res = await fetch(apiUrl + "/all", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) throw new Error("Failed to fetch slots");
          const slots = await res.json();
          dataBody.innerHTML = "";

          // sort slots for display (by day then slotNumber)
          const dayOrder = {
            Monday: 1,
            Tuesday: 2,
            Wednesday: 3,
            Thursday: 4,
            Friday: 5,
            Saturday: 6,
          };
          slots.sort((a, b) => {
            const d1 = dayOrder[a.day] || 99;
            const d2 = dayOrder[b.day] || 99;
            if (d1 !== d2) return d1 - d2;
            return (a.slotNumber || 0) - (b.slotNumber || 0);
          });

          slots.forEach((ts) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${ts.day}</td>
              <td>${ts.startTime}</td>
              <td>${ts.endTime}</td>
              <td>${ts.slotNumber}</td>
              <td>
                <button class="btn-custom btn-warning" onclick="editSlot(${ts.slotId})">Edit</button>
                <button class="btn-custom btn-danger" onclick="deleteSlot(${ts.slotId})">Delete</button>
              </td>
            `;
            dataBody.appendChild(tr);
          });

          document.getElementById("data-section").style.display = slots.length
            ? "block"
            : "none";
        } catch (err) {
          console.error(err);
        }
      }

      // Validate times & slot
      function validateInputs(start, end, slot) {
        let ok = true;
        startError.style.display = "none";
        endError.style.display = "none";
        slotError.style.display = "none";

        if (!timeRegex.test(start)) {
          startError.style.display = "block";
          ok = false;
        }
        if (!timeRegex.test(end)) {
          endError.style.display = "block";
          ok = false;
        }
        if (ok) {
          // ensure start < end
          const [sh, sm] = start.split(":").map(Number);
          const [eh, em] = end.split(":").map(Number);
          const startMinutes = sh * 60 + sm;
          const endMinutes = eh * 60 + em;
          if (endMinutes <= startMinutes) {
            endError.textContent = "End time must be after start time";
            endError.style.display = "block";
            ok = false;
          }
        }
        if (!Number.isInteger(slot) || slot < 1) {
          slotError.style.display = "block";
          ok = false;
        }

        return ok;
      }

      // Add/Update Slot
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          day: document.getElementById("day").value.trim(),
          startTime: document.getElementById("startTime").value.trim(),
          endTime: document.getElementById("endTime").value.trim(),
          slotNumber: parseInt(document.getElementById("slotNumber").value, 10),
        };

        if (
          !validateInputs(
            payload.startTime,
            payload.endTime,
            payload.slotNumber
          )
        )
          return;

        try {
          if (editId) {
            const res = await fetch(`${apiUrl}/update/${editId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || "Update failed");
            }
            editId = null;
          } else {
            const res = await fetch(apiUrl + "/add", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || "Save failed");
            }
          }

          form.reset();
          loadTimeSlots();
        } catch (err) {
          alert("Error saving time slot: " + (err.message || ""));
          console.error(err);
        }
      });

      // Edit Slot
      async function editSlot(id) {
        try {
          const res = await fetch(`${apiUrl}/get/${id}`, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) throw new Error("Failed to fetch slot");
          const ts = await res.json();
          document.getElementById("day").value = ts.day;
          // ensure times are shown as HH:MM (backend should return same format)
          document.getElementById("startTime").value = ts.startTime;
          document.getElementById("endTime").value = ts.endTime;
          document.getElementById("slotNumber").value = ts.slotNumber;
          editId = id;
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          alert("Error fetching time slot");
          console.error(err);
        }
      }

      // Delete Slot
      async function deleteSlot(id) {
        if (!confirm("Delete this time slot?")) return;
        try {
          const res = await fetch(`${apiUrl}/delete/${id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) throw new Error("Delete failed");
          loadTimeSlots();
        } catch (err) {
          alert("Error deleting time slot");
          console.error(err);
        }
      }

      // Search (client side simple)
      searchBox.addEventListener("input", () => {
        // simple reload and filtering on client (keeps code simple)
        loadTimeSlots();
      });

      // Initial load
      loadProfile();
      loadTimeSlots();
    </script>
  </body>
</html>
